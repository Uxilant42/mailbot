# ============================================
# –ò–ú–ü–û–†–¢–´
# ============================================
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message
import mail_service
import code_parser

# ============================================
# –°–û–ó–î–ê–ù–ò–ï –†–û–£–¢–ï–†–ê
# ============================================
router = Router()

# ============================================
# –•–ï–ù–î–õ–ï–† –î–õ–Ø –ö–û–ú–ê–ù–î–´ /start
# ============================================
@router.message(Command('start'))
async def start_handler(message: Message):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥"""
    
    welcome_text = (
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –Ω–∞–π—Ç–∏ –∫–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –ø–æ—á—Ç–µ.\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/getcode - –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∏—Å—å–º–∞\n"
        "/help - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"
    )
    
    await message.answer(welcome_text)

# ============================================
# –•–ï–ù–î–õ–ï–† –î–õ–Ø –ö–û–ú–ê–ù–î–´ /getcode
# ============================================
@router.message(Command('getcode'))
async def get_code_handler(message: Message):
    """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–¥ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∏—Å—å–º–∞"""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
    await message.answer("‚è≥ –ò—â—É –∫–æ–¥...")
    
    try:
        # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–∏—Å—å–º–æ –∏–∑ Gmail
        email_data = mail_service.get_latest_email()
        
        # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º - –µ—Å—Ç—å –ª–∏ –ø–∏—Å—å–º–∞?
        if email_data is None:
            await message.answer(
                "üì≠ –ü–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ –ø—É—Å—Ç\n"
                "–ü–∏—Å–µ–º –ø–æ–∫–∞ –Ω–µ—Ç"
            )
            return
        
        # –®–∞–≥ 3: –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–æ–¥ –≤ —Ç–µ–∫—Å—Ç–µ –ø–∏—Å—å–º–∞
        code = code_parser.find_verification_code(email_data['body'])
        
        # –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if code:
            # –ö–û–î –ù–ê–ô–î–ï–ù - —É—Å–ø–µ—Ö!
            response = (
                f"‚úÖ –¢–≤–æ–π –∫–æ–¥: {code}\n\n"
                f"–û—Ç: {email_data['from']}\n"
                f"–¢–µ–º–∞: {email_data['subject']}"
            )
            await message.answer(response)
        else:
            # –ö–û–î –ù–ï –ù–ê–ô–î–ï–ù
            response = (
                f"üîç –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø–∏—Å—å–º–µ\n\n"
                f"–û—Ç: {email_data['from']}\n"
                f"–¢–µ–º–∞: {email_data['subject']}"
            )
            await message.answer(response)
    
    except Exception as e:
        # –û–®–ò–ë–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ò–õ–ò –î–†–£–ì–ê–Ø –ü–†–û–ë–õ–ï–ú–ê
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø–æ—á—Ç–µ\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
        )
        print(f"–û—à–∏–±–∫–∞: {e}")  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

# ============================================
# –•–ï–ù–î–õ–ï–† –î–õ–Ø –ö–û–ú–ê–ù–î–´ /help
# ============================================
@router.message(Command('help'))
async def help_handler(message: Message):
    """–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"""
    
    help_text = (
        "üìñ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:\n\n"
        "1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ —Å–∞–π—Ç–µ\n"
        "2. –£–∫–∞–∂–∏ –ø–æ—á—Ç—É: shared-mail@gmail.com\n"
        "3. –û—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É /getcode\n"
        "4. –ü–æ–ª—É—á–∏ –∫–æ–¥ –∏ –≤–≤–µ–¥–∏ –µ–≥–æ –Ω–∞ —Å–∞–π—Ç–µ\n\n"
        "‚ö†Ô∏è –ë–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–¥ –∏–∑ –ü–û–°–õ–ï–î–ù–ï–ì–û –ø–∏—Å—å–º–∞"
    )
    
    await message.answer(help_text)
