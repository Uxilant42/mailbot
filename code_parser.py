# ============================================
# ИМПОРТЫ
# ============================================
import re

# ============================================
# РЕГУЛЯРНЫЕ ВЫРАЖЕНИЯ (ПАТТЕРНЫ)
# ============================================

# Паттерн 1: Код с ключевыми словами (ВЫСОКИЙ ПРИОРИТЕТ)
# Примеры: "code: 123456", "code: ABC123", "verification code: 5678"
PATTERN_WITH_KEYWORDS = r'(?:code|verification code|pin|verify|your code)[\s:]+([A-Z0-9]{4,8})'

# Паттерн 2: 6-значный цифровой код
# Примеры: 123456, 987654
PATTERN_SIX_DIGITS = r'\b\d{6}\b'

# Паттерн 3: 4-значный цифровой код
# Примеры: 1234, 5678
PATTERN_FOUR_DIGITS = r'\b\d{4}\b'

# Паттерн 4: Буквенно-цифровой код (6 символов)
# Примеры: A3B7C9, X1Y2Z3
PATTERN_ALPHANUMERIC = r'\b[A-Z0-9]{6}\b'

# ============================================
# ФИЛЬТРЫ (ЧТО ИСКЛЮЧИТЬ)
# ============================================

# Исключаем номера телефонов
EXCLUDE_PHONE = r'[\+\(]|(?:\d{1,3}[-\s]){2,}'

# Исключаем даты
EXCLUDE_DATE = r'(?:19|20)\d{2}|[\d]{1,2}[\/\.\-][\d]{1,2}'

# Исключаем суммы денег
EXCLUDE_MONEY = r'[$€₽£¥]'

# ============================================
# ФУНКЦИЯ ПОИСКА КОДА
# ============================================
def find_verification_code(text):
    """
    Ищет код подтверждения в тексте письма
    
    Аргументы:
        text (str): Текст письма
        
    Возвращает:
        str: Найденный код
        None: Если код не найден
    """
    
    if not text:
        return None
    
    # Приводим текст к верхнему регистру для единообразия
    text_upper = text.upper()
    
    # ============================================
    # ПОПЫТКА 1: КОД С КЛЮЧЕВЫМИ СЛОВАМИ
    # ============================================
    match = re.search(PATTERN_WITH_KEYWORDS, text_upper, re.IGNORECASE)
    if match:
        code = match.group(1)  # Берем только сам код (без ключевого слова)
        return code
    
    # ============================================
    # ПОПЫТКА 2: 6-ЗНАЧНЫЙ ЦИФРОВОЙ КОД
    # ============================================
    matches = re.findall(PATTERN_SIX_DIGITS, text)
    if matches:
        # Проверяем каждое совпадение
        for code in matches:
            if not is_filtered(code, text):
                return code
    
    # ============================================
    # ПОПЫТКА 3: 4-ЗНАЧНЫЙ ЦИФРОВОЙ КОД
    # ============================================
    matches = re.findall(PATTERN_FOUR_DIGITS, text)
    if matches:
        # Проверяем каждое совпадение
        for code in matches:
            if not is_filtered(code, text):
                return code
    
    # ============================================
    # ПОПЫТКА 4: БУКВЕННО-ЦИФРОВОЙ КОД
    # ============================================
    matches = re.findall(PATTERN_ALPHANUMERIC, text_upper)
    if matches:
        return matches[0]  # Возвращаем первый найденный
    
    # ============================================
    # КОД НЕ НАЙДЕН
    # ============================================
    return None

# ============================================
# ФУНКЦИЯ ФИЛЬТРАЦИИ
# ============================================
def is_filtered(code, text):
    """
    Проверяет, является ли код ложным срабатыванием
    
    Аргументы:
        code (str): Найденный код
        text (str): Полный текст письма
        
    Возвращает:
        bool: True если это НЕ код (нужно исключить), False если это код
    """
    
    # Находим позицию кода в тексте
    code_position = text.find(code)
    if code_position == -1:
        return False
    
    # Берем контекст вокруг кода (10 символов до и после)
    start = max(0, code_position - 10)
    end = min(len(text), code_position + len(code) + 10)
    context = text[start:end]
    
    # Проверка 1: Это номер телефона?
    if re.search(EXCLUDE_PHONE, context):
        return True
    
    # Проверка 2: Это дата?
    if re.search(EXCLUDE_DATE, context):
        return True
    
    # Проверка 3: Это сумма денег?
    if re.search(EXCLUDE_MONEY, context):
        return True
    
    # Проверка 4: Это год? (2024, 2025, 2026)
    if code in ['2024', '2025', '2026', '2027']:
        return True
    
    # Код прошел все проверки - это настоящий код!
    return False
